&emsp;
# Homography 单应矩阵

除了基本矩阵和本质矩阵, 二视图几何中还存在另一种常见的矩阵：单应矩阵 (Homography) $\pmb{H}$, 它描述了两个平面之间的映射关系。若场景中的特征点都落在同一平面上 (比如墙、地面等),则可以通过单应性来进行运动估计。这种情况在无人机携带的俯视相机或扫地机携带的顶视相机中比较常见

单应矩阵通常描述处于共同平面上的一些点在两张图像之间的变换关系。考虑在图像 $I_1$ 和 $I_2$有一对匹配好的特征点 $p_1$ 和 $p_2$ 。这些特征点落在平面 $P$ 上, 设这个平面满足方程:
$$
\pmb{n}^{\mathrm{T}} \pmb{P}+d=0
$$

稍加整理, 得:
$$
-\frac{\pmb{n}^{\mathrm{T}} \pmb{P}}{d}=1
$$

然后, 回顾本节开头的式 (7.1), 得:
$$
\begin{aligned}
\pmb{p}_2 & \simeq \pmb{K}(\pmb{R P}+\pmb{t}) \\
& \simeq \pmb{K}\left(\pmb{R} \pmb{P}+\pmb{t} \cdot\left(-\frac{\pmb{n}^{\mathrm{T}} \pmb{P}}{d}\right)\right) \\
& \simeq \pmb{K}\left(\pmb{R}-\frac{\pmb{t} \pmb{n}^{\mathrm{T}}}{d}\right) \pmb{P} \\
& \simeq \pmb{K}\left(\pmb{R}-\frac{\pmb{t} \pmb{n}^{\mathrm{T}}}{d}\right) \pmb{K}^{-1} \pmb{p}_1
\end{aligned}
$$

于是, 我们得到了一个直接描述图像坐标 $\pmb{p}_1$ 和 $\pmb{p}_2$ 之间的变换, 把中间这部分记为 $\pmb{H}$, 于是:
$$
\pmb{p}_2 \simeq \pmb{H} \pmb{p}_1
$$

它的定义与旋转、平移及平面的参数有关。与基础矩阵 $\pmb{F}$ 类似, 单应矩阵 $\pmb{H}$ 也是一个 $3 \times 3$ 的矩阵, 求解时的思路也和 $\pmb{F}$ 类似, 同样可以先根据匹配点计算 $\pmb{H}$, 然后将它分解以计算旋转和平移。把上式展开, 得:
$$
\left(\begin{array}{c}
u_2 \\
v_2 \\
1
\end{array}\right)=\left(\begin{array}{lll}
h_1 & h_2 & h_3 \\
h_4 & h_5 & h_6 \\
h_7 & h_8 & h_9
\end{array}\right)\left(\begin{array}{c}
u_1 \\
v_1 \\
1
\end{array}\right)
$$

请注意, 这里的等号是在非零因子下成立的。我们在实际处理中通常乘以一个非零因子使得 $h_9=1$ (在它取非零值时)。然后根据第 3 行, 去掉这个非零因子, 于是有:

$$
\begin{aligned}
u_2 & =\frac{h_1 u_1+h_2 v_1+h_3}{h_7 u_1+h_8 v_1+h_9} \\
v_2 & =\frac{h_4 u_1+h_5 v_1+h_6}{h_7 u_1+h_8 v_1+h_9} .
\end{aligned}
$$

整理得：
$$
\begin{aligned}
& h_1 u_1+h_2 v_1+h_3-h_7 u_1 u_2-h_8 v_1 u_2=u_2 \\
& h_4 u_1+h_5 v_1+h_6-h_7 u_1 v_2-h_8 v_1 v_2=v_2 .
\end{aligned}
$$

这样一组匹配点对就可以构造出两项约束（事实上有三个约束，但是因为线性相关，只取前两个), 于是自由度为 8 的单应矩阵可以通过 4 对匹配特征点算出 (注意, 这些特征点不能有三点共线的情况 ), 即求解以下的线性方程组 (当 $h_9=0$ 时, 右侧为零):
$$
\left(\begin{array}{cccccccc}
u_1^1 & v_1^1 & 1 & 0 & 0 & 0 & -u_1^1 u_2^1 & -v_1^1 u_2^1 \\
0 & 0 & 0 & u_1^1 & v_1^1 & 1 & -u_1^1 v_2^1 & -v_1^1 v_2^1 \\
u_1^2 & v_1^2 & 1 & 0 & 0 & 0 & -u_1^2 u_2^2 & -v_1^2 u_2^2 \\
0 & 0 & 0 & u_1^2 & v_1^2 & 1 & -u_1^2 v_2^2 & -v_1^2 v_2^2 \\
u_1^3 & v_1^3 & 1 & 0 & 0 & 0 & -u_1^3 u_2^3 & -v_1^3 u_2^3 \\
0 & 0 & 0 & u_1^3 & v_1^3 & 1 & -u_1^3 v_2^3 & -v_1^3 v_2^3 \\
u_1^4 & v_1^4 & 1 & 0 & 0 & 0 & -u_1^4 u_2^4 & -v_1^4 u_2^4 \\
0 & 0 & 0 & u_1^4 & v_1^4 & 1 & -u_1^4 v_2^4 & -v_1^4 v_2^4
\end{array}\right)\left(\begin{array}{l}
h_1 \\ h_2 \\ h_3 \\ h_4 \\ h_5 \\ h_6 \\ h_7 \\ h_8
\end{array}\right)=\left(\begin{array}{l}
u_2^1 \\ v_2^1 \\ u_2^2 \\ v_2^2 \\ u_2^3 \\ v_2^3 \\ u_2^4 \\ v_2^4
\end{array}\right)
$$

这种做法把 $\pmb{H}$ 矩阵看成了向量, 通过解该向量的线性方程来恢复 $\pmb{H}$, 又称直接线性变换法 ( Direct Linear Transform)。与本质矩阵相似, 求出单应矩阵以后需要对其进行分解, 才可以得到相应的旋转矩阵 $\pmb{R}$ 和平移向量 $\pmb{t}$ 。分解的方法包括数值法与解析法与本质矩阵的分解类似,单应矩阵的分解同样会返回 4 组旋转矩阵与平移向量, 并且同时可以计算出它们分别对应的场景点所在平面的法向量。如果已知成像的地图点的深度全为正值 (即在相机前方), 则又可以排除两组解。最后仅剩两组解, 这时需要通过更多的先验信息进行判断。通常我们可以通过假设已知场景平面的法向量来解决，如场景平面与相机平面平行，那么法向量 $\pmb{n}$ 的理论值为 $\mathbf{1}^{\mathrm{T}}$

单应性在 SLAM 中具有重要意义。当特征点共面或者相机发生纯旋转时, 基础矩阵的自由度下降, 这就出现了所谓的退化 (degenerate)。现实中的数据总包含一些噪声, 这时候如果继续使用八点法求解基础矩阵, 基础矩阵多余出来的自由度将会主要由噪声决定。为了能够避免退化现象造成的影响, 通常我们会同时估计基础矩阵 $\pmb{F}$ 和单应矩阵 $\pmb{H}$, 选择重投影误差比较小的那个作为最终的运动估计矩阵